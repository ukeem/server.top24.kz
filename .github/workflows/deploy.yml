# @format

name: Deploy Next.js App

on:
    push:
        branches:
            - main # –î–µ–ø–ª–æ–π –ø—Ä–∏ –ø—É—à–µ –≤ `main`
    pull_request:
        branches:
            - main # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ Pull Request

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
              uses: actions/checkout@v4

            - name: üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 18
                  cache: "npm"

            - name: üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
              run: npm install

            - name: üî® –°–±–æ—Ä–∫–∞ Next.js
              run: npm run build

            - name: ‚úÖ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
              run: npm test

    deploy:
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
              uses: actions/checkout@v4

            - name: üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 18
                  cache: "npm"

            - name: üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
              run: npm install

            - name: üî® –°–±–æ—Ä–∫–∞ Next.js
              run: npm run build

            - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      cd /var/www/server.top24.kz
                      git pull origin main
                      npm install
                      npm run build
                      pm2 restart server
